<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <link href="/webjars/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="/webjars/jquery/jquery.min.js"></script>
    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>
    <style>
body {
	margin: 0 auto;
	max-width: 800px;
	padding: 0 20px;
}

.container {
	border: 2px solid #dedede;
	background-color: #f1f1f1;
	border-radius: 5px;
	padding: 10px;
	margin: 10px 0;
}

.darker {
	border-color: #ccc;
	background-color: #ddd;
}

.container::after {
	content: "";
	clear: both;
	display: table;
}

.container img {
	float: left;
	max-width: 60px;
	width: 100%;
	margin-right: 20px;
	border-radius: 50%;
}

.container img.right {
	float: right;
	margin-left: 20px;
	margin-right: 0;
}

.time-right {
	float: right;
	color: #aaa;
}

.time-left {
	float: left;
	color: #999;
}

    .user-img img {
        width: 100xp;
        height: 100px;
        box-shadow: 0px 0px 3px #848484;
        border-radius: 50%;
    }

    .user-img {
        margin-top: -50px;
        margin-bottom: 35px;
    }
</style>
</head>

<script type="text/javascript">

var mensaje;
var stompClient = null;
var usuario;
var room;

class ChatMessage {
	constructor(content, type){
		this.content = content;
		this.type = type;
	}
}

/*function init(){
	$("#container-super").hide();
	$("#envios").hide();

}*/
function init2(){
    ingresar();
	connectAndSubscribe();
}
function connectAndSubscribe(){
	console.info('Connecting to WS...');
	var socket = new SockJS('/stompendpoint');
	stompClient = Stomp.over(socket);

	stompClient.connect({}, function (frame){
		console.log('Connected: ' + frame);
		console.log('Connected: ' + room);
		stompClient.subscribe("/topic/stompendpoint."+room, function (eventbody){
			console.log("Recibido");
			var mensajeARepartir = JSON.parse(eventbody.body);
			agregar(mensajeARepartir)
		});
	});
}

function enviarMensaje(){
	mensaje = document.querySelector('#contenido');

	var chatMessage = {
            content: mensaje.value,
            type: 'CHAT',
            sender: usuario
        };
	console.log(chatMessage);
	stompClient.send("/app/stompendpoint."+room+".send", {}, JSON.stringify(chatMessage));
}

function agregar(contenido){



	//var contenido = $("#contenido").val();

	console.log(contenido.sender)
	console.log(usuario)
	console.log(contenido.sender==usuario)
	if(contenido.type == "CHAT" && contenido.sender==usuario){
		var mensaje = "<div class='container'> <img src='/images/avatar.png' alt='Avatar' style='width: 100%;'> <p>"+contenido.content+"</p> <span class='time-left'>"+contenido.sender+"</span> </div>";
		$("#container-super").append(mensaje);
	}else if(contenido.type == "CONEXION" && contenido.sender!=usuario){
		var mensajeConexion = "<div class='container' style='width: 50%;'> <img style='width: 50%;'> <p>"+contenido.content+"</p> </div>";
		$("#container-super").append(mensajeConexion);
	}
	else if(contenido.type == "CHAT" && contenido.sender!=usuario){
		var mensaje = "<div class='container darker'> <img src='/images/avatar.png' alt='Avatar' class='right' style='width: 100%;'> <p>"+contenido.content+"</p> <span class='time-left'>"+contenido.sender+"</span> </div>";
		$("#container-super").append(mensaje);
	}

}

function ingresar(){
	//usuario = $("#nombreUsuario").val();
	usuario = localStorage.getItem("selectedUser");
	//room = $("#room").val();
	room =localStorage.getItem("selectedRoom");
	console.log(usuario);
	console.log(room);
	/*$("#logear").css({
		  display: 'none',
		  visibility: 'hidden'
		});
	$("#container-super").show();
	$("#envios").show();
    */
	var mensajeInicial1 = "<div class='container'> <img src='/images/avatar.png' alt='Avatar' style='width: 100%;'> <p>Hola "+usuario+", te doy la bienvenida </p> </div>";
	var mensajeInicial2 = "<div class='container darker'> <img src='/images/avatar.png' alt='Avatar' class='right' style='width: 100%;'> <p>ï¿½Disfrutalo!</p> </div>";
	$("#container-super").append(mensajeInicial1);
	$("#container-super").append(mensajeInicial2);
	//conexion();

}




$(function (){
	$("#conectar").click(function(){ init2(); });
	$("#enviar").click(function(){ enviarMensaje(); });
	//  $("#ingresar").click(function(){ ingresar(); });

});

</script>

<body style=background: #66999 url(/images/Fondo.jpg)
center center cover no-repeatfixed;>

<div class="jumbotron" style="text-align: center; height: 200px;">
    <h1>Chat</h1>
</div>

<!--<div id="logear" class="modal-dialog text-center">
    <div class="col-sm-12 main-section">
        <div class="modal-content">
            <div class="col-12 user-img">
                <img src="/images/user.png" />
            </div>
            <div class="col-12">
                <div class="form-group" id="user-group">
                    <input id="nombreUsuario" type="text" class="form-control"
                           placeholder="Nombre de usuario" name="username" />
                </div>
                <div class="form-group" id="room-group">
                    <input id="room" type="text" class="form-control"
                           placeholder="Nombre de la sala" name="room" />
                </div>
                <button type="submit" class="btn btn-primary" id="ingresar">
                    <i class="fas fa-sign-in-alt"></i> Ingresar
                </button>
            </div>
        </div>
    </div>
</div>-->


<div id="container-super">
</div>
<div id="envios" class="input-group mb-3">
    <input id="contenido" type="text" class="form-control"
           placeholder="Escibe un mensaje" aria-label="Recipient's username"
           aria-describedby="basic-addon2">
    <div class="input-group-append">
        <button id="enviar" class="btn btn-outline-secondary" type="button">Enviar</button>
        <button id="conectar" class="btn btn-outline-secondary" type="button">conectar</button>
    </div>
</div>

</body>
<script src="js/chat.js"></script>
<script src="js/servicios.js"></script>
<script src="js/usuario.js"></script>
<script src="js/stomp.js"></script>
<script src="js/app.js"></script>
</html>